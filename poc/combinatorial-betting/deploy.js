// Complete deployment script for local Anvil
const { ethers } = require('ethers');
const fs = require('fs');
const path = require('path');

// Connect to Anvil
const provider = new ethers.JsonRpcProvider('http://127.0.0.1:8545');
const PRIVATE_KEY = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
const deployer = new ethers.Wallet(PRIVATE_KEY, provider);

// MockUSDC contract
const MOCK_USDC_ABI = [
  "constructor()",
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)",
  "function transfer(address to, uint256 amount) returns (bool)",
  "function approve(address spender, uint256 amount) returns (bool)",
  "function mint(address to, uint256 amount)"
];

// Simplified MockUSDC bytecode (ERC20 with mint function)
const MOCK_USDC_BYTECODE = '0x608060405234801561001057600080fd5b506040518060400160405280600981526020017f4d6f636b205553444300000000000000000000000000000000000000000000008152506040518060400160405280600481526020017f555344430000000000000000000000000000000000000000000000000000000081525081600390816100899190610341565b5080600490816100999190610341565b5050506100b83361009b633b9aca0060066104dd565b6100bd60201b60201c565b610549565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361012c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161012390610561565b60405180910390fd5b61013e6000838361014260201b60201c565b5050565b505050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806101c957607f821691505b6020821081036101dc576101db610182565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026102447fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610207565b61024e8683610207565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061029561029061028b84610266565b610270565b610266565b9050919050565b6000819050919050565b6102af8361027a565b6102c36102bb8261029c565b848454610214565b825550505050565b600090565b6102d86102cb565b6102e38184846102a6565b505050565b5b81811015610307576102fc6000826102d0565b6001810190506102e9565b5050565b601f82111561034c5761031d816101e2565b610326846101f7565b81016020851015610335578190505b610349610341856101f7565b8301826102e8565b50505b505050565b600082821c905092915050565b600061036f60001984600802610351565b1980831691505092915050565b6000610388838361035e565b9150826002028217905092915050565b6103a182610147565b67ffffffffffffffff8111156103ba576103b9610152565b5b6103c482546101b1565b6103cf82828561030b565b600060209050601f83116001811461040257600084156103f0578287015190505b6103fa858261037c565b865550610462565b601f198416610410866101e2565b60005b8281101561043857848901518255600182019150602085019450602081019050610413565b868310156104555784890151610451601f89168261035e565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008160011c9050919050565b6000808291508390505b60018511156104f0578086048111156104cc576104cb61046a565b5b60018516156104db5780820291505b80810290506104e985610499565b94506104b0565b94509492505050565b6000826104fc57600190506105b8565b8161050a57600090506105b8565b8160018114610520576002811461052a57610559565b60019150506105b8565b60ff84111561053c5761053b61046a565b5b8360020a9150848211156105535761055261046a565b5b506105b8565b5060208310610133831016604e8410600b84101617156105905782820a90508381111561058b5761058a61046a565b5b6105b8565b61059d84848460016104a6565b925090508184048111156105b4576105b361046a565b5b8290505b9392505050565b60006105ca82610266565b91506105d583610266565b92506106027fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff84846104ed565b905092915050565b610a3c806106196000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce567146101315780634000aea01461014f57806370a082311461016b57806395d89b411461019b578063a9059cbb146101b957610093565b806306fdde0314610098578063095ea7b3146100b657806318160ddd146100e657806323b872dd14610104575b600080fd5b6100a06101e9565b6040516100ad9190610652565b60405180910390f35b6100d060048036038101906100cb91906107175761027b565b5b6040516100dd919061076e565b60405180910390f35b6100ee61029e565b6040516100fb9190610798565b60405180910390f35b61011e600480360381019061011991906107b3565b6102a8565b60405161012891906107615b60405180910390f35b6101396102d7565b6040516101469190610822565b60405180910390f35b61015f600480360381019061015a9190610715565b6102e0565b60405161016c919061076e565b60405180910390f35b6101856004803603810190610180919061083d565b610303565b6040516101929190610798565b60405180910390f35b6101a361034b565b6040516101b09190610652565b60405180910390f35b6101d360048036038101906101ce9190610715565b6103dd565b6040516101e0919061076e565b60405180910390f35b6060600380546101f89061089f565b80601f01602080910402602001604051908101604052809291908181526020018280546102249061089f565b80156102715780601f1061024657610100808354040283529160200191610271565b820191906000526020600020905b81548152906001019060200180831161025457829003601f168201915b5050505050905090565b600080610286610400565b9050610293818585610408565b600191505092915050565b6000600254905090565b6000806102b3610400565b90506102c08582856105d1565b6102cb858585610665565b60019150509392505050565b60006006905090565b6000806102eb610400565b90506102f88185856103dd565b600191505092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461035a9061089f565b80601f01602080910402602001604051908101604052809291908181526020018280546103869061089f565b80156103d35780601f106103a8576101008083540402835291602001916103d3565b820191906000526020600020905b8154815290600101906020018083116103b657829003601f168201915b5050505050905090565b6000806103e8610400565b90506103f5818585610665565b600191505092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610477576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161046e90610942565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036104e6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104dd906109d4565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040516105c49190610798565b60405180910390a3505050565b60006105dd8484610303565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811461065f5781811015610649576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161064090610a40565b60405180910390fd5b61065e8484848403610408565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036106d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106cb90610ad2565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610743576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161073a90610b64565b60405180910390fd5b61074e8383836108df565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110156107d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107cb90610bf6565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516108c29190610798565b60405180910390a36108d58484846108e4565b50505050565b505050565b505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610920578082015181840152602081019050610905565b60008484015250505050565b6000601f19601f8301169050919050565b6000610948826108e9565b61095281856108f4565b9350610962818560208601610905565b61096b8161092c565b840191505092915050565b6000602082019050818103600083015261099081846109;

async function main() {
  console.log('ðŸš€ Deploying to Anvil Local Network...\n');
  
  const balance = await provider.getBalance(deployer.address);
  console.log('Deployer:', deployer.address);
  console.log('Balance:', ethers.formatEther(balance), 'ETH\n');
  
  // Step 1: Deploy MockUSDC
  console.log('ðŸ“ Step 1: Deploying MockUSDC...');
  
  try {
    const MockUSDC = new ethers.ContractFactory(MOCK_USDC_ABI, MOCK_USDC_BYTECODE, deployer);
    const usdc = await MockUSDC.deploy();
    await usdc.waitForDeployment();
    const usdcAddress = await usdc.getAddress();
    
    console.log('âœ… MockUSDC deployed to:', usdcAddress);
    
    // Check balance
    const usdcBalance = await usdc.balanceOf(deployer.address);
    console.log('   Deployer USDC balance:', ethers.formatUnits(usdcBalance, 6), 'USDC\n');
    
    // Mint additional USDC to test accounts
    console.log('ðŸ’° Minting USDC to test accounts...');
    const account1 = '0x70997970C51812dc3A010C7d01b50e0d17dc79C8';
    const account2 = '0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC';
    
    await usdc.mint(account1, ethers.parseUnits('10000', 6));
    await usdc.mint(account2, ethers.parseUnits('10000', 6));
    
    console.log('âœ… Minted 10,000 USDC to Account #1:', account1);
    console.log('âœ… Minted 10,000 USDC to Account #2:', account2);
    
    // Save deployment info
    const deployment = {
      network: 'anvil-local',
      chainId: 31337,
      timestamp: new Date().toISOString(),
      contracts: {
        MockUSDC: usdcAddress,
      },
      accounts: {
        deployer: deployer.address,
        treasury: deployer.address,
        opsWallet: deployer.address,
      }
    };
    
    fs.writeFileSync(
      path.join(__dirname, 'deployment.json'),
      JSON.stringify(deployment, null, 2)
    );
    
    console.log('\nâœ… Deployment complete!');
    console.log('\nðŸ“‹ Contract Addresses:');
    console.log('   MockUSDC:', usdcAddress);
    console.log('\nðŸ“„ Deployment details saved to: deployment.json');
    
    console.log('\nðŸŽ¯ Next Steps:');
    console.log('   1. Use Remix IDE to compile CombinatorialPool_v2_FIXED.sol');
    console.log('   2. Deploy via Remix with these constructor args:');
    console.log(`      USDC: ${usdcAddress}`);
    console.log(`      Treasury: ${deployer.address}`);
    console.log(`      Ops Wallet: ${deployer.address}`);
    console.log('   3. Or wait for full automated deployment\n');
    
  } catch (error) {
    console.error('âŒ Deployment failed:', error.message);
    process.exit(1);
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
